#include "altc/altio.h"
#include "s3k/s3k.h"

#include "malloc.h"
#include "canary.h"
#include "canary_trap.h"

// strcpy can not be found even when importing string.h?
void alt_strcpy(char* dst, char* src){
	while(*src){
		*dst = *src;
		dst++;
		src++;
	}
}

// alt_gets does not work for me, but alt_getchar does work
// for some reasson the enter key gets carrage return, and not char newline (even though I am on linux)
// I assume that alt_gets expects newline
void alt2_gets(char* dst){
	char input;
	while(1){
		input = alt_getchar();
		if(input=='\r' || input=='\n' || !input) {
			*dst = 0; // add null at the end
			break;
		}
		*dst = input;
		dst++;
	}
}

int main(void)
{
	alt_puts("Testing malloc exploit");
	init_canary_table();
	s3k_init_malloc();
	init_canary_trap();
	char *user_string_copy = s3k_simple_malloc(10);
	char user_input[10];
	alt_printf("Enter text: \n");
	
	// Dangerous user input
	alt2_gets(user_input);
	alt_printf("GOT USER STRING %s\n", user_input);
	
	// Dangerous copy function
	alt_strcpy(user_string_copy, user_input);

    alt_printf("user_sting_copy 0x%x\n", user_string_copy);
	
	check_canary();
}
