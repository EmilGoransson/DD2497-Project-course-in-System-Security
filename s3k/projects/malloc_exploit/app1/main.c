#include "altc/altio.h"
#include "s3k/s3k.h"

#include "malloc.h"
#include "canary.h"
#include "canary_trap.h"

// strcpy can not be found even when importing string.h?
void alt_strcpy(char* dst, char* src){
	while(*src){
		*dst = *src;
		dst++;
		src++;
	}
}

// alt_gets does not work for me, but alt_getchar does work
// for some reasson the enter key gets carrage return, and not char newline (even though I am on linux)
// I assume that alt_gets expects newline
void alt2_gets(char* dst){
	char input;
	while(1){
		input = alt_getchar();
		if(input=='\r' || input=='\n' || !input) {
			*dst = 0; // add null at the end
			break;
		}
		*dst = input;
		dst++;
	}
}

int main(void)
{
	alt_puts("Testing malloc exploit");
	init_canary_table();
	s3k_init_malloc();
	init_canary_trap();

	// CAN NOT GET THEM TO BE IN RIGHT ORDER ON THE STACK,
	// Only workaround is to use a structs since they guarante
	// the order to be correct
	struct{
		char user_input[10];
		char *user_string_copy;
	} vulnerable_variables;
	
	vulnerable_variables.user_string_copy = s3k_simple_malloc(10);
	
	alt_printf("a 0x%x, b 0x%x\n", &vulnerable_variables.user_input[0], &vulnerable_variables.user_string_copy);

	alt_printf("Enter text: \n");
	
	// Dangerous user input 0x80022000
	// SIMULATE USER INPUT (not easy in qemu, so I will add directly in code)
	alt_strcpy(vulnerable_variables.user_input, "aaaaaaaaaaaaaaaa  \2"); // Set pointer to 0x80022020
	alt_printf("GOT USER STRING %s\n", vulnerable_variables.user_input);
	alt_printf("Other pointer: 0x%x\n", vulnerable_variables.user_string_copy);
	// Dangerous copy function
	alt_strcpy(vulnerable_variables.user_string_copy, vulnerable_variables.user_input);

    
	check_canary();
}
